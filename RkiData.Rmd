---
title: "Score"
author: "Uwe Sterr"
date: "3/22/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
```

## Corona data in Germany

Der Corona Hub von Esri stellt relevante, kartographische Informationsebenen bereit. Diese werden im Zusammenhang mit dem Monitoring der Corona Virus Ausbreitung genutzt. Zusätzlich zu den raumbezogenen Fallzahlen ergeben sich dadurch weitere Informationen, die durch Gesellschaft, Politik, Verwaltung, Wissenschaft und Wirtschaft genutzt werden können. 

### RKI Corona Bundesländer

Feature Service mit den aktuellen Covid-19 Infektionen pro 100.000 Einwohner auf die deutschen Bundesländer. Der Service wird täglich mit den aktuellen Fallzahlen des Robert Koch-Instituts aktualisiert. 
More details at https://npgeo-corona-npgeo-de.hub.arcgis.com/datasets/ef4b445a53c1406892257fe63129a8ea_0?geometry=-23.183%2C46.270%2C39.439%2C55.886&selectedAttribute=faelle_100000_EW

JSON API at:
https://services7.arcgis.com/mOBPykOjAyBO2ZKk/arcgis/rest/services/Coronaf%C3%A4lle_in_den_Bundesl%C3%A4ndern/FeatureServer/0/query?where=1%3D1&outFields=*&outSR=4326&f=json

### RKI Corona Landkreise
Feature Service mit den aktuellen Covid-19 Infektionen pro 1 00.000 Einwohner auf die deutschen Landkreise. Der Service wird täglich mit den aktuellen Fallzahlen des Robert Koch-Instituts aktualisiert.
More details at https://npgeo-corona-npgeo-de.hub.arcgis.com/datasets/917fc37a709542548cc3be077a786c17_0?geometry=-20.857%2C46.269%2C41.765%2C55.886

JSON API at:
https://services7.arcgis.com/mOBPykOjAyBO2ZKk/arcgis/rest/services/RKI_Landkreisdaten/FeatureServer/0/query?where=1%3D1&outFields=*&outSR=4326&f=json

### RKI historical data

Tabelle mit den aktuellen Covid-19 Infektionen pro Tag. Die Tabelle wird täglich mit den aktuellen Fallzahlen des Robert Koch-Instituts aktualisiert.

JSON API at:
https://services7.arcgis.com/mOBPykOjAyBO2ZKk/arcgis/rest/services/RKI_COVID19/FeatureServer/0/query?where=1%3D1&outFields=*&outSR=4326&f=json (Meldedatum is in JSON time stamp format, i.e. Unix time in ms)

use instead
https://opendata.arcgis.com/datasets/dd4580c810204019a7b8eb3e0b329dd6_0.geojson

An excel sheet is avaialble at
'https://opendata.arcgis.com/datasets/dd4580c810204019a7b8eb3e0b329dd6_0.csv' 



It offers the following attributes

- Altergruppe (Text)
- AnzahlFall (Number)
- AnzahlTodesfall (Number)
- Bundesland (Text)
- Datenstand (Text)
- Geschlecht (Text)
- IdBundesland (Number)
- Landkreis (Text)
- LandkreisId (Text)
- Meldedatum  (Date or Time)
- ObjectId (UNique ID)


```{r readData}
library(tidyverse) ; library(httr) ; library(jsonlite)
library(lubridate)
library(plotly)
path <- "https://rki-covid-api.now.sh/api/states"
stateData <- fromJSON("https://rki-covid-api.now.sh/api/states")


# Data 
# https://npgeo-corona-npgeo-de.hub.arcgis.com/datasets/ef4b445a53c1406892257fe63129a8ea_0/geoservice?geometry=-23.513%2C46.270%2C39.768%2C55.886
#stateEsri <- fromJSON("https://services7.arcgis.com/mOBPykOjAyBO2ZKk/arcgis/rest/services/Coronaf%C3%A4lle_in_den_Bundesl%C3%A4ndern/FeatureServer/0/query?where=1%3D1&outFields=*&outSR=4326&f=json")

# https://npgeo-corona-npgeo-de.hub.arcgis.com/datasets/917fc37a709542548cc3be077a786c17_0/geoservice

#countiesEsri <- fromJSON("https://services7.arcgis.com/mOBPykOjAyBO2ZKk/arcgis/rest/services/RKI_Landkreisdaten/FeatureServer/0/query?where=1%3D1&outFields=*&outSR=4326&f=json")

#historyData <- fromJSON("https://services7.arcgis.com/mOBPykOjAyBO2ZKk/arcgis/rest/services/RKI_COVID19/FeatureServer/0/query?where=1%3D1&outFields=*&outSR=4326&f=json")

historyData <- fromJSON("https://opendata.arcgis.com/datasets/dd4580c810204019a7b8eb3e0b329dd6_0.geojson")

historyDf <- historyData[["features"]][["properties"]]
#historyDf$MeldeDate <- as_datetime(historyDf$Meldedatum/1000)
historyDf$MeldeDate <- as_datetime(historyDf$Meldedatum)
ggplot(historyDf %>% group_by(Landkreis) %>% filter(Landkreis == "LK Esslingen"), aes(y= AnzahlFall, x=MeldeDate)) + geom_point()


test <- fromJSON("https://services7.arcgis.com/mOBPykOjAyBO2ZKk/arcgis/rest/services/RKI_COVID19/FeatureServer/0/query?where=1%3D1&outFields=*&outSR=4326&f=json")

statesDf <- stateData[["states"]]
statesDf$date <- Sys.Date()
```

## Thomas Excel sheet


### parameters



```{r defineParameters}

# Betroffene

Ygesamt	<- 83e6 # Gesamtmenge
n0_erfasst <- 	120 # Anzahl erfasster Infizierter am Beginn 
beginn_date	<- ymd(2020-03-01) # Datum Beginn



#Krankenhausaufenthalt
kh_normal	<- 4.50/100 # Anteil an aktuellen Infizierten [percent]
t_kh	<- 14 # Dauer [tage]
dt_inf_kh	<- 8 # Versatz nach Infektion [tage]
kh_intensiv	<- 25.00/100 #  Anteil Intensivstation [percent]
t_intensiv	<- 10 # Dauer Intensivstation [tage]
dt_kh_int	<- 1 # Versatz Krankenhaus - Intensivstation [tage]

# Expertenparameter für Infektionsverlauf


ges_inf_rate <- 	70/100 # Gesättige Infektionsrate [percent]
faktor_n_inf <- 	15 # Faktor der nicht erfassten Infizierten
ta	<- 10 # Dauer Ansteckbarkeit  [tage]
r0	<- 13 # Neuansteckung durch einen Infizierten
tod_rate <- 	2.00/100 # Sterblichkeit
td_tod <- 	8 # Dauer Infektion bis Tod  [tage]
reduzierung_datum	<- as.Date("2020-03-20") # Datum Reduktionsmassnahme
reduzierung_rt <- 	30/100 # Reduktion der Repr.rate/Tag

# Ausgabe


Y_inf_limit <- Ygesamt*ges_inf_rate/faktor_n_inf
Rt <- r0^(1/ta)



```
  
- Gesamt zu erwartende Infizierte: `r Ygesamt*ges_inf_rate`  
- Gesamtanzahl erfasster Infizierter: `r Ygesamt*ges_inf_rate/faktor_n_inf`  
- Reproduktionsrate pro Tag: `r r0^(1/ta)`  

```excel


Tägiche Reproduktionsrate Rt=IF(B2<=0,0,MAX(Rt-F2*(Rt-1)/Y_inf_limit,0))
Aktuell Infizierte berechnet=D3+SUM(INDIRECT("e"&ROW()-1&":e"&MAX(ROW()-(ta-1),2)))
Restanteil Startwert=IF(ROW()<ta+2,n0_erfasst*(ta-ROW()+2)/ta,0)
Neu Infizierte berechnet=H3/faktor_n_inf
Erfasste Infizierte berechnet=MIN(E2+F2,Y_inf_limit)
Gesamt Infizierte berechnet=MIN(H2+G2,Ygesamt*ges_inf_rate)
Neu gesamt Infizierte berechnet=(B3-1)*G3
HZ1=IF(ROW()>dt_inf_kh+1,"E"&ROW()-dt_inf_kh,0)
HZ2=IF(ROW()>dt_inf_kh+1,    "E"&(ROW()-MIN(t_kh+dt_inf_kh,ROW()-2)),0)
KH berechnet=IF(ROW()>dt_inf_kh+1,kh_normal*SUM(INDIRECT(I3):INDIRECT(J3)),0.1)
HZ3=IF(ROW()>dt_inf_kh+dt_kh_int+1,"E"&ROW()-dt_inf_kh-dt_kh_int,0)
HZ4=IF(ROW()>dt_kh_int+dt_inf_kh+1,    "E"&(ROW()-MIN(t_intensiv+dt_kh_int+dt_inf_kh-1,ROW()-2-dt_inf_kh+dt_inf_kh)),0)
Intensiv berechnet=IF(ROW()>dt_kh_int+dt_inf_kh+1,kh_normal*kh_intensiv*SUM(INDIRECT(L3):INDIRECT(M3)),0.1)
HZ5=IF(ROW()>td_tod+1,"E"&(ROW()-td_tod),0)
Neue Tote berechnet=IF(ROW()>td_tod+1,  tod_rate*@INDIRECT(O3),0.1)
Tote berechnet=P2+Q2
```


```{r calcDf}



startDate <- as.Date('2020-03-01')
endDate <- as.Date('2020-05-31')

coronaDf <- tibble(date = seq(startDate, endDate,by = 1))

Rt-F2*(Rt-1)/Y_inf_limit

ifelse(B2<=0,0,MAX(Rt-120*(Rt-1)/Y_inf_limit,0))

Rt-120*(Rt-1)/Y_inf_limit
```



```{r test}

calcReduzierteRt <-  function(df){
if (calcDf$Tag < reduzierung_datum ) {
  df <- tail(df, 1)
  ReduzierteRt <- df$TaeglichReproduktionsRateRt-df$WirksamkeitReduktion * (df$TaeglichReproduktionsRateRt-1) * reduzierung_rt
  ReduzierteRt
}
}





calcDf <- tibble(Tag                               = startDate,
       TaeglichReproduktionsRateRt       = Rt,
       AktuellInfizierteBerechnet        = n0_erfasst,
       RestanteilStartwert               = NA,
       NeuInfizierteBerechnet            = NA,
       ErfassteInfizierteBerechnet       = AktuellInfizierteBerechnet,
       GesamtInfizierteBerechnet         = AktuellInfizierteBerechnet*faktor_n_inf,
       NeuGesamtInfizierteBerechnet      = NA,
       KhBerechnet                       = NA,
       IntensivBerechnet                 = 0,
       NeueToteBerechnet                 = 0,
       ToteBerechnet                     = 0,
       ReduktionAbDatum                  = 0,
       WirksamkeitReduktion              = 0,
       ReduzierteRt                      = 0,
       MaxKhBerechnet                    = 0,
       MaxIntBerechnet                   = 0,
  
 )

calcReduzierteRt(calcDf)

calcDf$RestanteilStartwert =23

```

```{r}

test <- tribble(
  
  ~Tag, ~TaeglichReproduktionsRateRt, ~GesamtInfizierteBerechnet, ~ReduzierteRt ,
  
  startDate, Rt, n0_erfasst*faktor_n_inf, Rt )
startDate <- as.Date('2020-03-17')
endDate <- as.Date('2020-04-17')



for (i in seq(startDate, endDate,by = 1)) {
#add_test <- tibble(  Tag = test$Tag, TaeglichReproduktionsRateRt = test$TaeglichReproduktionsRateRt, 
 #                    GesamtInfizierteBerechnet = test$GesamtInfizierteBerechnet, ReduzierteRt = test$ReduzierteRt)
  

#test <- tibble::add_row(test,add_test)

test <- add_row(test,  Tag = test$Tag[i], TaeglichReproduktionsRateRt = test$TaeglichReproduktionsRateRt[i], 
                     GesamtInfizierteBerechnet = test$GesamtInfizierteBerechnet[i], ReduzierteRt = test$ReduzierteRt[i])
  
}
```



